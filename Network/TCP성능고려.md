HTTP는 TCP의 바로 위에서 동작하는 계층이기 때문에 TCP의 성능에 크게 영향을 받는다. 따라서 HTTP 통신 지연은 대부분 TCP 통신 지연으로 인해 발생한다.

HTTP 통신 지연의 원인은 여러가지가 있다
- DNS 이름 해결
클라이언트는 URI에서 웹 서버의 IP 주소와 포트 번호를 알아내야한다. 만약 최근에 접속한 적이 없는 주소인 경우 DNS를 통해 호스트 명일 IP 주소로 변환하는 과정을 거쳐야 한다. 여기서 지연이 발생한다
- TCP 커넥션 과정
TCP는 신뢰성있는 데이터 전송을 위해서 3 way handshake의 커넥션 과정이 필요하다. 클라이언트가 서버에 커넥션 요청을 보내고 서버는 이에 응답하고 다시 클라이언트가 응답하는 3번의 패킷 교환을 거쳐야한다.
- 요청 메시지 전달
TCP 커넥션이 맺어진 후 클라이언트에서 요청 메시지를 작성하고 메시지가 인터넷을 통해서 서버에 전달되고 서버는 해당 요청을 처리한다. 이때 지연이 발생할 수 있다
- 응답 메시지 전달
서버는 요청 메시지에 대한 요청 처리 결과를 응답 메시지에 담아서 인터넷을 통해 클라이언트에 전달한다.

## TCP관련 지연 이슈
---

### TCP 3 way handshake 지연
새로운 TCP 커넥션을 맺기 위해서는 3번의 IP 패킷 교환이 이루어진다.

1. 클라이언트에서 서버에 커넥션을 요청하기위해 SYN 플래그를 가지는 TCP 패킷을 서버로 전달한다

2. 서버는 클라이언트로부터 커넥션 요청을 받으면 커넥션 요청이 받아드려졌음을 의미하는 SYN과 ACK 플래그를 담은 패킷을 전송한다

3. 마지막으로 클라이언트는 연결이 성공적으로 맺어졌음을 알리기위해 서버에 ACK 패킷을 전달한다. ACK 패킷에 데이터를 전달할 수도 있다.

HTTP 트랜잭션에서 전달할 데이터의 크기가 매우 작을 경우 TCP 커넥션으로인한 지연이 크게 눈에 띈다.

### 확인 응답 지연
TCP 세그먼트는 패킷의 순번과 데이터 무결성 체크섬을 가진다. 각 세그먼트 수신자는 세그먼트를 온전히 받으면 확인 응답 패킷을 송신자에게 반환하고, 일정 시간내에 확인 응답을 받지 못한경우 데이터를 재전송한다.

확인 응답은 그 크기가 작기 때문에 TCP는 같은 방향으로 송춝되는 데이터 패킷에 확인응답을 편승(Piggyback)한다. 네트워크를 효율적으로 사용하기 위해서 확인 응답을 버퍼에 임시로 저장해두고 같은 방향으로 송출되는 데이터 패킷이 있을 경우 편승시키고 그렇지 않을 경우 확인 응답용 패킷을 만들어 전송하는 것이다.

하지만 HTTP 트랜잭션의 특성상 요청과 응답으로만 이루어져있기 때문에 송출 데이터 패킷에 확인 응답을 편승할 기회가 많지 않다. 따라서 확인 응답 지연 알고리즘으로 인한 지연이 많이 발생한다.

### TCP Slow start
TCP 혼잡제어 기능을 제공한다. Slow start는 혼잡 제어 기법중 하나이다. TCP는 처음부터 최대한의 데이터를 전송하는 것이 아니라, 데이터가 전송이 성공하면 전송 받은 ACK 패킷의 수 마다 전달할 패킷의 수를 1씩 늘린다. 성공할 때 마다 전송할 패킷의 수가 2배씩 늘어나는 셈이다.

만약 네트워크 혼잡이 발생하면 발생한 지점을 기억해두고 다시 패킷을 1개 전송하며 혼잡이 발생했던 지점의 절반은 2배씩 늘리다가, 그 이후에는 1개씩 패킷을 늘려간다.

### 네이글 알고리즘과 TCP_NODELAY
TCP는 40바이트의 큰 헤더를 가진다. 따라서 많은 수의 TCP 패킷을 전달하면 네트워크 성능이 크게 떨어진다. 따라서 패킷을 전송하기 전에 많은 양의 TCP 데이터를 한 개의 데이터 덩어리로 합치는 방법이 있는데, 이러한 알고리즘을 네이글 알고리즘이라 한다.

네이글 알고리즘은 세그먼트가 최대 크기가 되지 않으면 전송하지 않는다. 다만 모든 패킷이 확인 응답을 받았을 경우에는 최대 크기보다 작은 패킷의 전송을 허락한다. 

네이글 알고리즘의 단점은 아래와 같다.

1. 크기가 작은 HTTP 메시지는 패킷을 채우지 못하기 때문에 응답이 지연될 수 있다.
2. 네이글 알고리즘은 확인 응답이 도착할 때까지 데이터 전송을 지연하지만, 확인응답 지연 알고리즘은 확인 응답을 지연하기 때문에 같이 적용할 경우 성능이 좋지않다.
