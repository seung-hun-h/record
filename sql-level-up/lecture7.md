# 7강 조건 분기, 집합 연산, 윈도우 함수, 갱신
---

## 1. SQL과 조건 분기
- SQL에도 조건 분기를 하는 방법이 있지만 절차 지향형 프로그래밍 언어와 차이가 있다
- 절차 지향형 프로그래밍 언어는 조건 분기를 문장 단위로 한다
- SQL은 조건 분기를 '식' 단위로 한다

### CASE 식의 구문
- CASE 식의 구문에는 '단순 CASE 식'과 '검색 CASE 식' 두 종류가 있지만, 검색 CASE 식이 단순 CASE 식을 포함하므로 검색 CASE 식만 알아도 충분하다

```SQL
CASE WHEN [평가식] THEN [식]
	 WHEN [평가식] THEN [식]
	 WHEN [평가식] THEN [식]
	 ELSE [식]
```

### CASE 식의 작동
- 위에서 부터 WHEN 구의 평가식부터 평가되고 조건이 맞으면 THEN 구에 지정한 식이 리턴되며 CASE 식 전체가 종료된다
- 절차 지향형 언어의 조건 분기는 문장을 실행하고 딱히 리턴하지 않는 반면, SQL의 조건 분기는 특정한 값(상수)을 리턴한다
- CASE 식의 강력한 점은 **식**이라는 것이다
	- SELECT, WHERE, GROUP BY, HAVING, ORDER BY 구 어디에나 사용할 수 있다

## 2. SQL의 집합 연산
### UNION으로 합집합 구하기
- UNION은 두 테이블의 합집합을 구한다
- 레코드가 중복되는 경우 중복 레코드를 모두 제외하고 하나만 남긴다
	- 이는 INTERSECT, EXCEPT도 동일하다
- 중복되는 레코드를 모두 남기고 싶으면 UNION ALL을 하면된다
### INTERSECT로 교집합 구하기
- INTERSECT는 두 테이블의 교집합을 구한다
- 중복된 것이 있으면 해당 레코드는 제외된다

### EXCEPT로 차집합 구하기
- EXCEPT는 두 테이블의 차집합을 구한다
- UNION과 INTERSECT의 결과가 두 테이블의 순서와 무관한 것과 다르게 EXCEPT는 두 테이블의 순서에 따라 결과가 달라진다

## 3. 윈도우 함수
- 윈도우 함수의 가장 큰 특징은 '집약 기능이 없는 GROUP BY 구'이다
- GROUP BY구는 자르기와 집약이라는 두 개의 기능으로 구분된다
- 윈도우 함수는 여기서 자르기 기능만 있는 것이다

```SQL
SELECT address, COUNT(*)
FROM Address
GROUP BY address;
```

| address  | count |
| -------- | ----- |
| 서울시   | 3     |
| 인천시   | 2     |
| 부산시   | 2     |
| 속초시   | 1     |
| 서귀포시 | 1     |

- 윈도우 함수도 테이블을 자르는 것은 GROUP BY와 같다
- 윈도우 함수는 이를 'PARTITION BY'라는 구로 수행한다.
	- 차이점은 집약을 하지 않으므로 출력 결과의 레코드 수가 입력되는 레코드 수와 같다는 것이다

```SQL
SELECT address, COUNT(*) OVER (PARTITION BY address)
FROM Address
```

| address  | count |
| -------- | ----- |
| 속초시   | 1     |
| 인천시   | 2     |
| 인천시   | 2     |
| 서울시   | 3     |
| 서울시   | 3     |
| 서울시   | 3     |
| 부산시   | 2     |
| 부산시   | 2     |
| 서귀포시 | 1     |
|          |       |

- 윈도우 함수 RANK는 지정된 키로 레코드에 순위를 붙이는 함수이다
- RANK 함수는 숫자가 같으면 같은 순위로 표시한다

```SQL
SELECT name
	, age
	, RANK() OVER(ORDER BY age DESC) AS rnk
FROM Address;
```

| name   | age | rnk |
| ------ | --- | --- |
| 하린   | 55  | 1   |
| 준     | 45  | 2   |
| 기주   | 32  | 3   |
| 민     | 32  | 3   |
| 인성   | 30  | 5   |
| 아린   | 25  | 6   |
| 하진   | 21  | 7   |
| 인아   | 20  | 8   |
| 빛나래 | 19  | 9   |
- 기주와 민의 나이가 같으므로 인성은 4위가 아닌 5위가 되었다.
- 순위를 건너뛰지 않으려면 DENSE_RANK를 사용하면된다

---
### OVER 함수

데이터를 통계나 집게할 때 단일 함수랑 집계 함수를 함께 사용할 수 없기 때문에 서브쿼리를 사용하게 된다. 이떄 서브 쿼리로 인해 전체 쿼리가 복잡해질 수 있는데 이때 OVER 함수를 사용할 수 있다

OVER()에는 'PARTITION BY'나 'ORDER BY'를 추가적으로 작성해줄 수 있다.

---
