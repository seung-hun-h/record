# 멱등성 프로듀서
---
## 전달 신뢰성
- 멱등성이란 여러번 연산을 수행하더라도 동일한 결과를 나타내는 것을 의미한다
- 멱등성 프로듀서는 동일한 데이터를 여러번 전송하더라도 카프카 클러스터에 단 한 번만 저장되는 것을 의미한다
- 기본 프로듀서의 동작은 적어도 한 번 전달(at least once delivery) 기능을 지원한다

- At least once: 적어도 한 번 이상
- At most once: 최대 한 번
- Exactly once: 정확히 한 번

### 멱등성 프로듀서
- 데이터의 중복 적재를 막기위해 `enable,idempotence` 옵션을 사용해 정확히 한 번 전달을 지원한다
- 카프카 0.11.0 이후 지원하는 옵션이고 기본은 false이며, 카프카 3.0.0 버전부터는 기본 값이 true이다

### 멱등성 프로듀서의 동작
- 멱등성 프로듀서는 기본 프로듀서와 달리 데이터를 브로커로 전달할 때 프로듀서 PID(Producer unique Id)와 시퀀스 넘버를 함께 전달한다
- 브로커는 PID와 SID를 확인해 중복을 방지한다

### 멱등성 프로듀서의 한계
- 멱등성 프로듀서는 동일한 세션에서만 정확히 한 번 전달을 보장한다
	- 동일한 세션이란 PID가 동일한 경우를 말한다
- 프로듀서 애플리케이션이 재시작된다면 PID는 변경된다.
- PID가 다르면 브로커는 다른 프로듀서가 데이터를 전달했다고 판단해 데이터 중복이 발생할 수 있다

### 멱등성 프로듀서로 설정한 경우 옵션
- `enable.idempotence = true`로 설정하면 일부 옵션이 강제된다
- 데이터 재전송 횟수를 결정하는 `retries`는 `Integer.MAX_VALUE`로 설정된다
- `acks`는 all로 설정된다
- 멱등성 프로듀서는 데이터를 한 번만 전송하는 것이 아니라 브로커에 한 번만 적재되는 것이다
	- 따라서 위 같은 설정이 강제된다

### OutOfOrderSequenceException
- 멱등성 프로듀서의 시퀀스 넘버는 0부터 시작하여 숫자를 1씩 더한 값이 전달된다
- 시퀀스 넘버가 일정하지 않은 경우 `OutOfOrderSequenceException`이 발생한다
- 이 예외가 발생한 경우 시퀀스 넘버의 역전 현상이 발생할 수 있기 때문에 순서가 중요한 데이터를 전송하는 프로듀서는 해당 예외가 발생한 경우 대응 방안을 고려해야 한다


# 트랜잭션 프로듀서, 컨슈머
---
## 트랜잭션 프로듀서 동작
- 카프카에서 트랜잭션은 다수의 파티션에 데이터를 저장할 경우 모든 데이터에 대해 동일한 원자성을 만족시키기 위해 사용된다
- 원자성을 만족시킨다는 의미는 다수의 데이터를 동일 트랜잭션으로 묶어 전체 데이터를 처리하거나 전체 데이터를 처리하지 않도록 한다는 것을 의미한다
- 데이터 레코드에 트랜잭션의 시작과 끝을 표현하기 위해 트랜잭션 레코드를 함께 보낸다

![[Pasted image 20230328084628.png]]

## 트랜잭션 컨슈머 동작
- 트랜잭션 컨슈머는 파티션에 저장된 트랜잭션 레코드를 보고 트랜잭션이 완료되었음을 확인하고 데이터를 가져간다
- 트랜잭션 레코드는 실질적인 데이터를 가지고 있지는 않고 트랜잭션이 끝난 상태를 표시하는 정보만 가지고 있다
![[Pasted image 20230328084744.png]]
