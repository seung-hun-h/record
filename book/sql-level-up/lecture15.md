# 15강 반복계의 공포
---
- 반복계의 가장 '좋은 점'은 SQL을 잘모르더라도 사용할 수 있다는 것이다
	- SQL 처리를 단순화 할 수 있다
- 포장계 SQL은 비즈니스 로직을 SQL에 넣으려다 보니 구문이 복잡해져서 유지 보수성이 떨어지는 SQL구문이 만들어 질 수 있다

## 1. 반복계의 단점
- 반복계의 단점은 한마디로 '성능'이다
- 반복계로 구현한 코드는 포장계로 구현한 코드에 성능적으로 이길 수 없다
	- 반복계의 처리시간은 '처리 횟수 * 한 회에 걸리는 처리 시간'이므로 한 회에 걸리는 처리시간이 일정하다고 하면 처리 횟수에 비례한다
	- 포장계는 인덱스를 사용한 접근이고 실행 계획 변동이 없다고 가정하면 처리 시간이 완만하게 증가한다

### SQL 실행의 오버헤드
- 전처리
	1. SQL 구문을 네트워크로 전송
	2. 데이터베이스 연결
	3. SQL 구문 파스
	4. SQL 구문의 실행 계획 생성 또는 평가
- 후처리
	5. 결과 집합을 네트워크로 전송

- 1, 2, 5번은 최근에는 거의 문제되지 않는다
- 오버헤드 중 영향이 가장 큰 것은 3, 4이다
	- 파스는 데이터베이스가 SQL을 받을때마다 실행되므로 작은 SQL을 여러 번 반복하는 반복계에서는 오버헤드가 높아질 수 밖에 없다

### 병렬 분산이 힘들다
- 반복계는 반복 1회마다의 처리를 단순화하기 때문에 리소스를 분산해서 병렬 처리하는 최적화가 안된다
	- 데이터베이스는 대부분 RAID 디스크로 구성되어 I/O 부하를 분산할 수 있게 되어있다
	- 반복계에서 사용하는 SQL은 대부분 단순해서 1회의 SQL 구문이 접근하는 데이터의 양이 적다

### 데이터베이스의 진화로 인한 혜택을 받을 수 없다
- 데이터베이스의 진화를 위한 노력은 '대규모 데이터를 다루는 복잡한 SQL 구문'을 빠르게 하려는데 있다
- 반복계에서 사용되는 SQL은 대부분 단순해서 데이터베이 진화의 혜택을 누릴 수 없다
	- 실제로 반복계의 처리가 느려서 문제가 발생하는 경우 단순히 스케일 업하여 해결되는 경우가 많다

## 2. 반복계를 빠르게 만드는 방법은 없을까?
### 반복계를 포장계로 다시 작성
- 이는 애플리케이션의 수정을 말한다
- 실제 상황에서는 이러한 선택지를 사용할 수 없는 경우가 많다

### 각각의 SQL을 빠르게 수정
- 반복계에서 사용하는 SQL은 단순해서 튜닝 가능성이 제한된다
- INSERT 구문을 반복하는 경우는 특히 더 튜닝하기 어렵다

### 다중화 처리
- 가장 희망적인 선택지다
	- CPU 또는 디스크와 같은 리소스에 여유가 있고, 처리를 나눌 수 있는 키가 명확하게 정해져 있다면, 처리를 다중화해서 성능을 선형에 가깝게 스케일할 수 있다
- 데이터를 분할할수 있는 명확한 키가 없거나, 순서가 중요한 처리, 병렬화했을 때 물리 리소스가 부족하면 사용할 수 없다

---
- 반복계의 튜닝 선택지는 한정적이다
- 하지만 무조건 반복계를 적대시 할 필요는 없다

## 3. 반복계의 장점
### 실행 계획의 안정성
- 실행 계획의 변동 위험이 거의 없다
	- 실제 운용 중에 갑자기 실행 계획이 바뀌어 느려지는 현상은 일어나지 않는다
	- 비용 기반의 옵티마이저에서 긍정적으로 작용한다
	- SQL 구문 내부에서 결합을 사용하지 않아도 된다는 것이 크게 작용한다. 실행 계획이 변동해 결합 알고리즘이 변경되는 경우가 가장 골치 아프다
- 옵티마이저가 완벽하지 않은 현재 시점에서 안정적인 성능을 확보할 수 있다는 것은 큰 장점이다
- 포장계는 SQL 구문이 복잡한 만큼 실행 계획의 변동 가능성이 굉장히 크다
	- 힌트를 사용하거나, 조금 단순한 구문을 사용하는 것이 좋다

### 예상 처리 시간의 정밀도
- 실행 계획이 단순하면 예상 처리 시간의 정밀도가 높다
	- 처리 시간 = 한 번의 실행 시간 * 실행 횟수
- 포장계는 실행 계획에 따라 성능이 전혀 달라지므로 프로그램의  사양을 사전에 예상하기 힘들다

### 트랜잭션 제어가 편리
- 트랜잭션의 정밀도를 미세하게 제어할 수 있다
- 갱신 처리를 반복계에서 특정 반복 횟수마다 커밋하면, 중간에 오류가 발생해도 해당 지점 근처에서 다시 처리를 실행할 수 있다
- 포장계의 SQL 구문에서는 미세한 제어를 할 수 없다


