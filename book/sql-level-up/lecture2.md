# 2강 DBMS와 버퍼
---
- 버퍼는 성능에 굉장히 중요한 영향을 미친다
- 데이터베이스가 사용하는 메모리의 크기는 한정적이고 관리한 데이터의 양은 많다
- 데이터를 버퍼에 어떤식으로 확보할 것인가 하는 부분에서 트레이드 오프가 발생한다

## 1. 공짜 밥은 존재할까?
![image](https://user-images.githubusercontent.com/60502370/190884672-66fc5596-63f8-494b-b593-5e34d2ae4eb3.png)

- 세상에 공짜 밥은 존재하지 않는다
- 많은 데이터를 영속적으로 저장하려면 속도를 잃고, 속도를 얻고자 하면 많은 데이터를 영속적으로 저장하기 힘들다

## 2. DBMS와 기억장치의 관계
DBMS가 사용하는 대표적인 기억장치는 다음과 같다

- 하드 디스크
  - DBMS가 데이터를 저장하는 매체는 현재 대부분 HDD다
  - HDD는 기억장치 계층에서 한 가운데에 있는 2차 기억장치로 분류된다
  - 그렇게 좋은 점도 나쁜 점도 없는 기억장치다
- 메모리
  - 디스크에 비해 기억 비용이 비싸지만 속도가 매우 빠르다
  - 비용으로 인해 규보 있는 상용 시스템에서의 데이터베이스 내부 데이터를 모두 메모리에 올려 놓는 것은 불가능하다
- 버퍼를 활용한 속도 향상
  - DBMS가 일부 데이터라도 메모리에 올려 놓으려는 이유는 성능 향상 때문이다
  - 자주 접근하는 데이터를 메모리에 올려 놓으면 같은 SQL을 실행하더라도 디스크에 접근하지 않으므로 성능이 향상된다
  - 성능 향상 목적으로 사용되는 메모리를 버퍼와 캐시라고 한다
	  - 버퍼는 사용자와 저장소 사이에서 디스크 접근을 줄여주는 역할을 한다
	  - 캐시는 사용자와 저장소 사이에서 데이터 전송 지연을 완하시켜준다

## 3. 메모리 위에 있는 두 개의 버퍼
- DBMS가 사용하는 대표적인 메모리는 **데이터 캐시와 로그 버퍼**이다

### 데이터 캐시
- 디스크에 있는 데이터의 일부를 메모리에 유지하기 위해 사용하는 메모리 영역이다
- 캐시 내에서 데이터를 찾을 수 있으면 디스크에 접근하지 않고, 그렇지 않으면 디스크에 접근해서 데이터를 읽어 온다

### 로그 버퍼
- 로그 버퍼는 갱신 처리(INSERT, DELETE, UPDATE, MERGE)와 관련있다
- DBMS는 갱신 처리 SQL을 받으면 로그 버퍼 위에 변경 정보를 보내고 이후 디스크에 변경을 수행한다
- 데이터베이스의 갱신 처리는 SQL의 구문 실행 시점과 저장소에 갱신하는 시점에 차이가 있는 **비동기 처리**이다
	- 저장소는 검색 뿐 아니라 갱신에서 많은 시간이 소요되어, 장시간 대기 하지 않게 하기 위함이다

---

- [캐시 VS 버퍼](https://beenii.tistory.com/101)

---


## 4. 메모리의 성질이 초래하는 트레이드오프
### 휘발성
- 메모리에는 데이터 영속성이 없다
	- 하드웨어의 전원을 꺼버리면 메모리 위에 올라가있는 데이터가 전부 사라진다
- DBMS를 껐다 켜면 버퍼 위의 모든 데이터가 사라진다
- 미래에 메모리의 가격이 싸진다 하더라도 휘발성 문제를 해결하지 못하면 디스크를 완전히 대체할 수 없다

### 휘발성의 문제점
- 휘발성의 가장 큰 문제점은 메모리에 있던 데이터가 모두 사라져 데이터 부정합을 일으킨다는 것이다
- 로그 버퍼 위에 존재하는 데이터가 디스크 위의 로그 파일에 반영되기 전에 장애가 발생하면 데이터가 완전히 사라져 복구 조차 불가능 해진다
	- DBMS가 갱신을 비동기로 하는 이상 언제든 발생할 수 있는 문제다
- DBMS는 커밋 시점에 갱신 정보를 고르파일에 써, 장애가 발생해도 데이터 정합성을 유지할 수 있다
	- **커밋은 갱신을 확정하는 것이다**
	- 커밋 때는 반드시 디스크에 동기 접근이 발생한다

## 5. 시스템 특성에 따른 트레이드 오프
### 데이터 캐시와 로그 버퍼의 크기
- 일반적으로 DBMS의 데이터 캐시 크기와 로그 버퍼 크기중 데이터 캐시의 크기가 훨씬 크다
- 이는 데이터베이스가 기본적으로 검색을 메인으로 처리한다고 가정하기 때문이다
- 자주 검색하는 데이터를 캐시에 올려 놓는 것이 갱신에 값비싼 메모리를 사용하는 것보다 좋다고 생각하는 것이다

### 검색과 갱신 중에 중요한 것
- 검색과 갱신 중에 어떤 것이 더 우선되어야 하는가라는 트레이드 오프에 직면한다
- DBMS에서 리소스를 자동으로 조절할 수 있도록 할 수 있지만, 중요한 리소스의 배분을 자동으로 맡겨 놓는 것은 좋지 못하다
- 적절한 판단을 위해 데이터베이스가 어떠한 생각에 기반을 둬서 리소스를 배분하고 있는지를 이해하는 것이 중요하다

## 6. 추가적인 메모리 영역 '워킹 메모리'
### 언제 사용될까?
- 워킹 메모리는 정렬 또는 해시 관련 처리에 사용되는 작업용 영역이다
- 정렬은 ORDER BY 구, 집합 연산, 윈도우 함수 등의 기능을 사용할 때 실행된다
- 해시는 주로 테이블 등의 결합에서 해시 결합이 사용되는 때 실행된다
- 워킹 메모리 영역은 SQL에서 정렬 또는 해시가 필요한 때 사용되고, 종료되면 해제되는 임시영역이다
- 로그 버퍼와 데이터 캐시와는 다른 영역으로 관리된다
- 다루려는 데이터가 워킹 메모리 영역보다 클 경우 대부분의 DBMS가 저장소를 사용한다.
	- OS의 스왑과 유사하다
	- 디스크에 접근하면 속도가 느려진다

### 부족하면 어떻게 될까?
- 메모리가 부족해지는 순간 갑자기 느려지는 순간적인 변화가 일어나는 것이 문제다
- 여러개의 SQL 구문이 공유해서 사용하므로, 하나의 SQL은 잘 동작하지만 여러 SQL에서 문제가 발생할 수 있다
	- 이러한 상황은 재현하여 검사하기 어렵다

- DBMS는 자바가 힙 메모리를 벗어난 경우 OOM을 발생시키는 것과 달리 메모리가 부족하더라도 예외를 발생시키지 않는다
- 운영체제 정도의 급으로 처리 계속성을 담보하려 하기 떄문이다