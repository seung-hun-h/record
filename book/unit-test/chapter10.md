# 10. 데이터베이스 테스트
## 10.1 데이터베이스 테스트를 위한 전제 조건
- 형상 관리 시스템에 데이터베이스 유지
- 개발자마다 별도의 데이터베이스 인스턴스 사용
- 데이터베이스 배포에 마이그레이션 기반 방식 적용

### 10.1.1 데이터베이스를 형상 관리 시스템에 유지
- 데이터베이스를 테스트하는 방법의 첫 번째 단계는 데이터베이스 스키마를 일반 코드로 취급하는 것이다
  - 일반 코드와 마찬가지로 데이터베이스 스키마는 Git과 같은 형상 관리 시스템에 저장하는 것이 최선이다
- 모든 데이터베이스 스키마 업데이트를 형상 관리 시스템에 두면 원천 정보를 하나로 할 수 있고 일반 코드 변경과 함께 데이터베이스 변경을 추적할 수 있다

### 10.1.2 참조 데이터도 데이터베이스 스키마다
- 데이터베이스 스키마로 자주 거론되는 대상은 테이블, 뷰, 인텍스, 저장 프로시저 그리고 데이터베이스가 어떻게 구성되는 지에 대한 청사진을 형성하는 나머지 모든 것이다
- 참조 데이터 또한 데이터베이스 스키마이다
  - 참조 데이터는 애플리케이션이 제대로 작동하도록 미리 채워야 하는 데이터다
  - 따라서 참조 데이터도 형상 관리 시스템에 저장해야 한다

### 10.1.3 모든 개발자를 위한 별도의 데이터베이스 인스턴스
- 테스트 실행 속도를 극대화하려면 개발자마다 별도로 데이터베이스 인스턴스를 사용하라

### 10.1.4 상태 기반 데이터베이스 배포와 마이그레이션 기반 데이터베이스 배포
- 상태 기반 데이터베이스 배포 방식
  - 개발 내내 유지보수하는 모델 데이터베이스가 존재
  - 배포 중에 비교 도구가 스크립트를 생성해서 운영 데이터베이스를 모델 데이터베이스와 비교해 최신 상태를 유지한다
  - 상태 기반 접근 방식에서 비교 도구는 모든 어려운 작업을 수행한다
  - 상태를 형상 관리에 저장함으로써 상태를 명시갛고 비교 도구가 마이그레이션을 암묵적으로 제어할 수 있게 한다
- 마이그레이션 기반 데이터베이스 배포 방식
  - 데이터베이스를 어떤 버전에서 다른 버전으로 전화하는 명시적인 마이그레이션을 의미한다
  - 운영 데이터베이스와 개발 데이터베이스를 자동을 동기화하기 위한 도구를 쓸 수 없고, 업그레이드 스크립트를 직접 작성해야 한다
  - 마이그레이션을 명시적으로 하지만 상태를 암묵적으로 둔다. 데이터베이스 상태를 직접 볼 수 없으며 마이그레이션으로 조합해야 한다

## 10.2 데이터베이스 트랜잭션 관리
- 생략

## 10.3 테스트 데이터 생명 주기
- 공유 데이터베이스를 사용하면 통합 테스트를 서로 분리할 수 없는 문제가 발생한다. 이를 해결하기 위한 방법은 아래와 같다
  - 통합 테스트를 순차적으로 실행하라
  - 테스트 실행 간에 남은 데이터를 제거하라
- 테스트는 데이터베이스 상태에 따라 달라지면 안된다. 테스트는 데이터베이스 상태를 원하는 조건으로 만들어야 한다

### 10.3.1 병렬 테스트 실행과 순차적 테스트 실행
- 통합테스트는 순차적으로 실행하는 것이 실용적이다

### 10.3.2 테스트 실행 간 데이터 정리
- 모든 통합 테스트의 기초 클래스를 두고, 기초 클래스에 삭제 스크립트를 작성하라
- 테스트가 시작될 때마다 스크립트가 자동으로 실행될 수 있도록 할 수 있다

### 10.3.3 인메모리 데이터베이스 피하기
- 인메모리 데이터베이스는 일반 데이터베이스와 기능적으로 일관성이 없기 때문에 사용하지 않는 것이 좋다


## 10.4 테스트 구절에서 코드 재사용하기
- 통합 테스트는 가능한 짧게 하되 서로 결합하거나 가독성에 영향을 주지 않는 것이 중요하다
- 아무리 짧은 테스트일지라도 서로 의존해서는 안된다
- 테스트 시나리오의 전체 컨텍스트를 유지해야 하며, 진행 상황을 이해하려고 테스트 클래스의 다른 부분을 검사해서는 안된다
- 통합 테스트를 짧게 하기에 가장 좋은 방법은 비즈니스와 관련이 없는 기술적인 부분을 비공개 메서드나 헬퍼 메서드로 추출하는 것이다

- 후략

## 10.5 데이터베이스 테스트에 대한 일반적인 질문
### 10.5.1 읽기 테스트를 해야 하는가?
- 쓰기 를 철저히 테스트하는 것은 매우 중요하다
- 읽기 작업에는 해로운 버그가 없다
- 가장 복잡하거나 중요한 읽기 작업만 테스트하고 나머지는 무시하라

### 10.5.2 리포지터리 테스트를 해야 하는가?
- 리포지터리는 복잡도가 거의 없고 프로세스 외부 의존성인 데이터베이스와 통신한다
- 리포지터리는 컨트롤러 사분면에 해당한다
- 리포지터리는 그렇게 복잡하지 않으며 회귀 방지에서 일반적인 통합 테스트가 주는 이점과 겹친다
- 리포지터리를 테스트하기에 가장 좋은 방법은 리포지터리가 갖고 있는 약간의 복잡도를 별도의 알고리즘으로 추출하고 해당 알고리즘 전역 테스트를 작성하는 것이다
- 리포지터리는 직접 테스트하지 말고 포괄적인 통합 테스트 스위트의 일부로 취급하라