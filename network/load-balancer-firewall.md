# L4: Load Balancer, Firewall

4계층에서 동작하는 장비는 포트 번호, 시퀀스 번호, ACK 번호에 대해 이해해야 한다. 기존 2, 3 계층 장비에서 고려하지 않았던 통신의 방향성이나 순서 같은 통신 전반에 대한 관리하 필요하며 이런 정보를 세션 테이블이라는 공간에 담아 관리한다.

4 계층의 장비로는 로드 밸런서와 방화벽이 있고, 이러한 장비를 세션 장비라고 부르기도 한다. 세션 장비에서 고려해야 할 특징들은 다음과 같다

- 세션 테이블
  - 세션 장비는 세션 테이블 기반으로 운영
  - 세션 정보를 저장, 확인하는 작업에 대한 이해 필요
  - 세션 정보가 세션 테이블에 남아있는 라이프타임 고려
- Symmetric 경로 요구
  - Inbound와 Outbound 경로가 일치 해야 한다
- 정보 변경(로드 밸런서)
  - IP 주소가 변경되며 확장된 L7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경된다.
  - 세션 장비의 이런 요소가 서비스에 영향을 미친다
  - 따라서 애플리케이션 개발에서도 세션 장비에 대한 고려가 필요하다

## 로드 밸런서
서버나 장비의 부하를 분산하기 위해 사용되는 장비를 로드 밸런서라 한다. 서비스가 커지게 되면 스케일 업이나 스케일 아웃 방식으로 대응한다. 스케일 업은 비용이 매우 크기 때문에 일반적으로 스케일 아웃 방식을 사용한다. 

스케일 아웃 방식으로 여러 서버를 운영하더라도 사용자에게는 동일한 서비스를 제공해야 한다. 따라서 로드 밸런서가 서비스를 대표하는 IP 주소를 가지게 되고 그 밑에 시스템이 늘어나면 로드 밸런서가 각 시스템의 IP로 요청을 보낸다.

로드 밸런서는 동작하는 계층에 따라서 L4 로드 밸런서, L7 로드 밸런서로 나뉜다.

- L4 로드 밸런싱
  - 일반적인 로드 밸런서가 동작하는 방식
  - TCP, UDP 정보를 기반으로 로드 밸런싱을 수행한다
- L7 로드 밸런싱
  - HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱을 수행한다.
  - HTTP 헤더 정보나 URI 같은 정보를 기반으로 프로토콜을 이해한 후 부하를 분산할 수 있다
  - ADC(Application Delivery Controller)라고도 한다
  - 스퀴드(Squid)나 Nginx에서 수행하는 리버스 프록시와 유사한 기능을 갖고 있다.

최근 로드 밸런서는 L4, L7의 기능을 모두 제공한다. 데이터 센터에서 사용하는 로드 밸런서 장비는 설정에 따라서 L4, L7 로드 밸런싱을 제공한다. 클라우드에서는 L4, L7 로드 밸런싱을 지원하는 컴포넌트를 계층별로 구분해 전용으로 사용한다. AWS의 NLB(Network Load Balancer)가 L4, ALB(Application Load Balancer)가 L7 로드 밸런싱을 수행한다.

### L4 스위치
- 4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치
- 일반 스위치처럼 여러 개의 포트를 가지고 있다
- 부하 분산, 성능 취적화, 리다이렉션 기능을 제공한다
- 가상 서버, 가상 IP, 리얼 서버와 리얼 IP를 설정해야 한다
  - 가상 서버: 사용자가 바라보는 실제 서비스
  - 가상 IP: 사용자가 접근해야 하는 서비스 IP 주소
  - 리얼 서버: 실제 서비스를 수행하는 서버
  - 리얼 IP: 실제 서버 IP

### ADC
- 애플리케이션 계층(7계층)에서 동작하는 로드 밸런서
- 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작한다
  - 다양한 부하 분산, 정보 수정, 정보 필터링이 가능하다
- 대부분의 ADC는 L4 스위치의 기능을 포함한다
- 프락시로 동작한다
- 로드 밸런싱, 페일 오버, 리다이렉션 기능 제공
- 캐싱, 압축, 콘텐츠 변환 및 재작성, 인코딩 변환, 애플리케이션 프로토콜 최적화 기능 제공
- SSL 터널링 기능 제공
  - 클라이언트-로드밸런서: HTTPS
  - 로드밸런서-서버: HTTP

## 방화벽
네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용 하거나 차단 하는 장비를 방화벽이라고 부른다.

- 세션 정보를 장비 내부에 저장한다
- 패킷이 외부로 나갈 때 세션 정보를 저장하고, 패킷이 들어오거나 나갈 때 세션 정보를 먼저 참조한다
  - 패킷이 외부에서 시작된 것인지, 내부 사용자가 외부로 요청한 응답인지 확인한다

세션의 방향성을 파악하여 많은 정책을 비교적 간단하게 관리한다.
