- 파드는 Pending -> Running -> Succeeded/Failed 라이프 사이클을 가진다
	- 기본 컨테이너 중 적어도 하나 이상이 OK로 시작하면 Running 단계를 통과한다
	- 파드의 컨테이너가 실패로 종료되었는지 여부에 따라 Succeeded/Failed 단계로 이동한다
- 파드내에서 쿠버네티스틑 다양한 컨테이너의 상태를 추적하고 파드를 다시 정상 상태로 만들기 위해 취할 조치를 결정한다
- 파드는 파드의 수명 중 한 번만 스케줄된다

## 파드의 수명
- 파드는 임시 엔티티다
	- 파드가 생성되면 고유 ID가 할당되고, 종료 혹은 삭제될 때까지 노드에 스케줄된다
	- 노드가 종료되면 해당 노드에 스케줄된 파드는 삭제된다
- 파드는 자체적으로 자가 치유(Self-healing)되지 않는다
	- 파드가 노드에 스케줄된 후 노드가 실패하거나, 유지 관리 작업으로 축출되면 파드는 삭제된다

## 파드의 단계
- 파드의 `status`필드는 `phase`필드를 포함하는 `PodStatus` 오브젝트로 정의된다

| 값        | 의미                                                                                                                                                                                                       |
| --------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Pending   | 파드가 쿠버네티스 클러스터에 승인되었지만, 하나 이상의 컨테이너가 설정되지 않았고 실행할 준비가 되지 않았다. 파드가 스케줄되기 이전 시간뿐 아니라 네트워크를 통한 컨테이너 이미지 다운로드 시간도 포함된다 |
| Running   | 파드가 노드에 바인딩 되었고, 모든 컨테이너가 생성되었다. 적어도 하나의 컨테이너가 아직 실행 중이거나, 시작 또는 재시작 중에 있다                                                                           |
| Succeeded | 파드에 있는 모든 컨테이너들이 성공적으로 종료되었고, 재시작되지 않을 것이다                                                                                                                                |
| Failed    | 파드에 있는 모든 컨테이너가 종료되었고, 적어도 하나 이상의 컨테이너가 실패로 종료되었다.                                                                                                                   |
| Unknown   | 어떤 이유에 의해서 파드의 상태를 얻을 수 없다. 일반적으로 노드와의 통신 오류로 인해 발생한다                                                                                                               |

> `Terminating` 상태는 파드의 단계에 포함되지 않는다. 파드에는 우아하게(gracefully) 종료되도록 기간이 부여되며 그 기본값은 30초이다. 공식적인 파드의 상태는 아니고 metadata필드인 `deletionTimeStamp`가 설정된 상태를 말한다. 파드가 삭제되기전 파드의 종료과정이 진행중임을 나타내는 임시적인 상태다

## 컨테이너 상태
- 쿠버네티스트는 파드 내부의 각 컨테이너의 상태도 추적한다
- 파드가 노드에 스케줄링되면 kubelet은 컨테이너 런타임을 사용하여 파드에 대한 컨테이너 생성을 시작한다
- 컨테이너의 상태는 `Waiting`, `Running`, `Terminated`다

#### Waiting
- 시작을 완료하는데 필요한 작업을 실행하는 중이다
	- 컨테이너 이미지 레지스트리에서 이미지를 가져오는 작업 등등
#### Running
- 컨테이너가 문제 없이 실행되고 있음을 나타낸다

#### Terminated
- 컨테이너가 실행한 다음 완료 될때까지 실행되었거나, 어떤 이유로 실패
	- Running 상태인 컨테이너가 정상적으로 종료
	- 컨테이너가 어떠한 이유로 실패

### 컨테이너 재시작 정책
- 파드 `spec`의 `restartPolicy` 필드에 설정한다
	- Always, OnFailure, Never가 있다
	- 기본값은 Always다
- `restartPolicy`는 파드의 모든 컨테이너에 적용된다
	- kubelet에 의한 컨테이너 재시작만을 의미한다

## 파드의 컨디션
- 파드는 하나의 PodStatus를 가진다
- PodStatus는 파드가 통과했거나 통과하지 못한 PodConditions 배열을 가진다
	- `PodScheduled`: 파드가 노드에 스케줄
	- `PodHasNetwork`: (알파 기능, 명시적으로 활성화 해야함) 샌드박스가 성공적으로 생성되고 네트워킹이 구성되었다
		- SandBox는 파드의 격리된 실행환경을 말한다. 네트워크 격리, 리소스 격리, 볼륨 마운트, 보안 등등
	- `ContainerReady`: 파드의 모든 컨테이너가 준비되었다
	- `Initialized`: 모든 초기화 컨테이너가 성공적으로 완료되었다
		- 초기화 컨테이너는 앱 컨테이너들이 실행되기 전에 실행되는 특수한 컨테이너
	- `Ready`: 파드는 요청을 처리할 수 있으며 일치하는 모든 서비스의 로드 밸런싱 풀에 추가되어야 한다

| 필드 이름          | 설명                                                         |
| ------------------ | ------------------------------------------------------------ |
| type               | 컨디션 이름                                                  |
| status             | 컨디션이 적용가능한 지 여부. True, False, Unknown            |
| lastPropeTime      | 컨디션이 마지막으로 프로브된 시간                            |
| lastTransitionTime | 파드가 한 상태에서 다른 상태로 전환된 마지막 시간            |
| reason             | 컨디션의 마지막 전환에 대한 이유. 기계가 판동 가능           |
| message            | 컨드션의 마지막 전환에 대한 이유. 사람이 읽을 수 있는 메시지 |

## 파드 준비 상태(readiness)
- 파드가 클라이언트의 요청을 처리할 준비가 되었는지 여부를 나타내는 개념이다
- Readiness가 설정되면 쿠버네티스는 해당 파드에 트래픽을 라우팅할 수 있다
- 준비성 평가를 위한 추가적인 컨디션은 `spec.readinessGateway`에 추가할 수 있다

```yml
kind: Pod
...
spec:
  readinessGates:
    - conditionType: "www.example.com/feature-1"
status:
  conditions:
    - type: Ready                              # 내장된 PodCondition이다
      status: "False"
      lastProbeTime: null
      lastTransitionTime: 2018-01-01T00:00:00Z
    - type: "www.example.com/feature-1"        # 추가적인 PodCondition
      status: "False"
      lastProbeTime: null
      lastTransitionTime: 2018-01-01T00:00:00Z
  containerStatuses:
    - containerID: docker://abcd...
      ready: true
...
```

- 위 처럼 추가적인 컨디션이 적용되어 있는 경우 다음의 경우에만 파드가 준비되어 있다고 판단한다
	- 파드 내의 모든 컨테이너들의 준비 상태
	- `readinessGateway`에 지정된 모든 컨디션들이 `True`

## 컨테이너 프로브
- 프로브는 컨테이너에서 kubelet에 의해 주기적으로 수행되는 진단이다

### 체크 메커니즘
#### exec
- 컨테이너 내에서 지정된 명령어 실행
- 명령어 상태 코드 0으로 종료되면 진단이 성공
#### grpc
- gRpc를 사용하여 원격 프로시저 호출 수행
- 체크 대상이 gRpc 헬스 체크를 구현해야 한다
- status가 SERVING이면 성공
- 이 기능은 알파 기능. GRPCContainerProbe 기능 게이트를 활성화 해야 한다
#### httpGet
- 컨테이너의 IP 주소에 대한 HTTP GET 요청을 수행
- 200이상 400미만이면 진단이 성공
#### tcpSocket
- 지정된 포트에서 컨테이너 IP주소에 대해 TCP rjatkfmf tngod
- 포트가 활성화되어 있다면 진단이 성공

### 프로브 결과
#### Success
- 진단 성공
#### Failure
- 진단 실패
#### Unkown
- 진단 자체가 실패

### 프로브 종류
#### livenessProbe
- 컨테이너가 동작 중인지 여부 확인
- livenessProbe에 실패하면 컨테이너재시작 정책 대상이 된다
#### readinessProbe
- 컨테이너가 요청 처리할 준비가 되어있는지 여부
- readinessProbe에 실패하면 엔트포인트 컨트롤러는 파드에 연관된 모든 서비스들의 엔드포인트에서 파드의 IP주소를 제거한다
#### startupProbe
- 컨테이너 내의 애플리케이션이 시작되었는지 여부
- startupProbe가 실패하면 kubelet이 컨테이너를 죽이고 컨테이너는 재시작 정책의 대상이된다
- startupProbe가 주어진 경우 성공할 때까지 다른 나머지 프로브는 활성화 되지 않는다

## 파드의 종료
- 사용자가 파드 삭제를 요청하면 클러스터는 파드를 종료하기전 유예 기간을 기록하고 추적한다
- 컨테이너 런타임은 컨테이너 이미지에 정의된 `STOPSIGNAL`을 존중한다
- 유예기간이 만료되면 KILL 시그널이 나머지 프로세스로 전송되고, 그런 다음 API 서버로부터 삭제된다

### 강제 파드 종료
- 기본적으로 모든 삭제는 30초 이내에는 정상적으로 수행된다
- `kubectl delete` 명령은 유예기간을 설정할 수 있도록 `--grace-period=<seconds>` 옵션을 제공한다
- 유예기간을 0으로 설정하면 API 서버에서 파드가 즉시 삭제된다
- 강제삭제를 위해서는 `--force` 옵션을 추가한다
	- `kubectl --grace-period=0 --force`
- 강제삭제가 수행되면  API 서버는 실행 중인 노드에서 파드가 종료되었다는 kubelet의 확인을 기다리지 않는다